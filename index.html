<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SAM256//CREDITCITY — NYC v2 (Gov + CRE + Capital + Dual Rents)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --bg:#0D3643;
      --panel:#123F4F;
      --panel2:#0F3543;
      --text:#E6F1F3;
      --muted:#9FB7BF;
      --line:rgba(255,255,255,.10);
      --accent:#F2A65A;
      --accent2:#FFB703;
      --good:#39d98a;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --ice:rgba(180,220,255,.92);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 800px at 50% 35%, rgba(242,166,90,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 38%, rgba(255,183,3,.06), transparent 60%),
        radial-gradient(1200px 900px at 50% 50%, rgba(255,255,255,.05), transparent 62%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
      min-height:100vh;
      overflow-x:hidden;
    }
    .wrap{ max-width: 1460px; margin:0 auto; padding: 18px 16px 44px; }
    header{ display:flex; align-items:flex-start; justify-content:space-between; gap:16px; margin-bottom: 14px; }
    .brand{ display:flex; flex-direction:column; gap:6px; }
    .title{
      font-family:var(--mono);
      font-weight:800;
      letter-spacing:.08em;
      font-size: 18px;
      display:flex; align-items:center; gap:10px;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--good);
      box-shadow: 0 0 14px rgba(57,217,138,.7);
      transform: translateY(1px);
    }
    .subtitle{ color:var(--muted); font-size: 13px; line-height: 1.35; max-width: 860px; }
    .topbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    button{
      background: linear-gradient(180deg, rgba(242,166,90,.18), rgba(242,166,90,.08));
      border: 1px solid rgba(242,166,90,.35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-family: var(--mono);
      letter-spacing:.02em;
      transition: transform .08s ease, border-color .2s ease, background .2s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      user-select:none;
    }
    button:hover{ transform: translateY(-1px); border-color: rgba(255,183,3,.55); }
    button:active{ transform: translateY(0px); }
    button.secondary{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
    }
    button.danger{
      background: rgba(255,107,107,.12);
      border: 1px solid rgba(255,107,107,.35);
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px; border-radius: 999px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--muted); font-family: var(--mono); font-size: 11px;
    }
    .grid{ display:grid; grid-template-columns: 520px 1fr; gap: 14px; align-items:start; }
    .card{
      background: linear-gradient(180deg, rgba(18,63,79,.88), rgba(15,53,67,.78));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.20);
      backdrop-filter: blur(6px);
    }
    .card h3{
      margin:0 0 10px 0;
      font-family:var(--mono);
      font-size: 13px;
      letter-spacing:.10em;
      color: rgba(230,241,243,.92);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card h3 span.small{ font-family:var(--mono); color: var(--muted); letter-spacing: normal; font-size: 12px; }
    .controls{ display:flex; flex-direction:column; gap: 10px; }
    .row{ display:grid; grid-template-columns: 1fr auto; gap: 10px; align-items:center; }
    label{ font-size: 12px; color: var(--muted); font-family: var(--mono); letter-spacing:.02em; }
    .val{ font-family: var(--mono); font-size: 12px; color: rgba(230,241,243,.92); min-width: 98px; text-align:right; }
    input[type="range"]{ width:100%; accent-color: var(--accent2); }
    .split{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
    .statgrid{ display:grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
    .stat{
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.12);
    }
    .stat .k{ color: var(--muted); font-size: 11px; font-family: var(--mono); letter-spacing:.06em; margin-bottom: 6px; }
    .stat .v{ font-family: var(--mono); font-size: 14px; letter-spacing:.02em; }
    .footer{ margin-top: 12px; color: var(--muted); font-size: 12px; font-family: var(--mono); line-height: 1.45; opacity: .92; }
    .rightcol{ display:grid; grid-template-rows: 320px auto; gap: 14px; }
    #flowCanvas{
      width:100%; height: 290px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(900px 500px at 50% 50%, rgba(255,255,255,.06), transparent 62%),
        rgba(0,0,0,.12);
      display:block;
    }
    .charts{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .chartBox{ height: 270px; }
    canvas.chart{ width:100% !important; height:100% !important; }
    .mini{
      margin-top: 8px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      background: rgba(0,0,0,.10);
      color: rgba(230,241,243,.9);
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.45;
    }
    .mini b{ color: rgba(230,241,243,.96); }
    .tag{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid rgba(255,255,255,.14);
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      color: rgba(230,241,243,.92);
      font-family: var(--mono);
      font-size: 10px;
      margin-left: 8px;
    }
    @media (max-width: 1200px){
      .grid{ grid-template-columns: 1fr; }
      .charts{ grid-template-columns: 1fr; }
      .chartBox{ height: 250px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="title"><span class="dot"></span> SAM256//CREDITCITY — NYC v2</div>
      <div class="subtitle">
        Government + CRE + bank capital constraints + dual rents. Watch how the pipes shift:
        taxes/deficit spend, rent extraction, interest extraction, CRE booms, and credit crunches.
      </div>
    </div>
    <div class="topbar">
      <button id="btnPlay">▶ RUN</button>
      <button id="btnStep" class="secondary">STEP</button>
      <button id="btnReset" class="danger">RESET</button>
      <span class="pill" id="statusPill">t=0 months • paused</span>
    </div>
  </header>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <h3>NYC CALIBRATION <span class="small">macro + policy knobs</span></h3>

      <div class="controls">
        <div class="row"><label>Simulated households</label><div class="val" id="vSimHH">50,000</div></div>
        <input id="simHH" type="range" min="5000" max="120000" step="1000" value="50000"/>

        <div class="row"><label>Real NYC households represented</label><div class="val" id="vRealHH">3,380,000</div></div>
        <input id="realHH" type="range" min="1000000" max="4500000" step="10000" value="3380000"/>

        <div class="row"><label>Median household income (annual)</label><div class="val" id="vMedInc">$81,228</div></div>
        <input id="medInc" type="range" min="40000" max="200000" step="500" value="81228"/>

        <div class="row"><label>Mortgage rate (30y fixed APR)</label><div class="val" id="vRate">6.11%</div></div>
        <input id="rate" type="range" min="0" max="1200" step="1" value="611"/>

        <div class="row"><label>Home price (median / typical)</label><div class="val" id="vHome">$777,600</div></div>
        <input id="home" type="range" min="300000" max="2200000" step="5000" value="777600"/>

        <div class="row"><label>Homeownership rate</label><div class="val" id="vOwn">32.8%</div></div>
        <input id="own" type="range" min="5" max="70" step="1" value="33"/>

        <div class="row"><label>Rent (ASKING / StreetEasy-like, monthly)</label><div class="val" id="vAskRent">$3,585</div></div>
        <input id="askRent" type="range" min="1500" max="8000" step="25" value="3585"/>

        <div class="row"><label>Rent (IN-PLACE / ACS-like, monthly)</label><div class="val" id="vInPlace">$1,821</div></div>
        <input id="inPlace" type="range" min="800" max="5000" step="10" value="1821"/>

        <div class="row"><label>Tenant turnover (monthly)</label><div class="val" id="vTurn">1.20%</div></div>
        <input id="turn" type="range" min="10" max="300" step="5" value="120"/>

        <div class="row"><label>Bank target capital ratio (Equity/RWA)</label><div class="val" id="vCap">10.0%</div></div>
        <input id="cap" type="range" min="6" max="18" step="1" value="10"/>

        <div class="row"><label>Credit standards baseline (DTI max)</label><div class="val" id="vDTI">0.35</div></div>
        <input id="dti" type="range" min="15" max="60" step="1" value="35"/>

        <div class="row"><label>CRE share of bank loan book</label><div class="val" id="vCRE">25%</div></div>
        <input id="creShare" type="range" min="5" max="55" step="1" value="25"/>

        <div class="row"><label>Recession severity</label><div class="val" id="vRec">0.25</div></div>
        <input id="recession" type="range" min="0" max="70" step="1" value="25"/>

        <div class="row"><label>Gov size (spending as % of wages)</label><div class="val" id="vGovSize">30%</div></div>
        <input id="govSize" type="range" min="10" max="60" step="1" value="30"/>

        <div class="row"><label>Transfers generosity (bottom-heavy)</label><div class="val" id="vXfer">1.00×</div></div>
        <input id="xfer" type="range" min="40" max="180" step="1" value="100"/>

        <div class="row"><label>Sales tax rate (NYC-ish)</label><div class="val" id="vSales">8.875%</div></div>
        <input id="sales" type="range" min="0" max="1200" step="1" value="888"/>

        <div class="split">
          <button id="btnShock" class="secondary">⚡ RECESSION + CRE VACANCY</button>
          <button id="btnBoom" class="secondary">☀ CREDIT EASING</button>
        </div>
      </div>

      <div class="statgrid">
        <div class="stat"><div class="k">Total deposits (citywide)</div><div class="v" id="sDep">$0</div></div>
        <div class="stat"><div class="k">Total bank loans</div><div class="v" id="sLoans">$0</div></div>
        <div class="stat"><div class="k">Bank equity</div><div class="v" id="sEq">$0</div></div>
        <div class="stat"><div class="k">Bank cap ratio</div><div class="v" id="sCap">0.0%</div></div>
        <div class="stat"><div class="k">Gov debt (bonds outstanding)</div><div class="v" id="sGovDebt">$0</div></div>
        <div class="stat"><div class="k">Gov deficit (monthly)</div><div class="v" id="sDef">$0</div></div>
        <div class="stat"><div class="k">Asking vs In-place rent</div><div class="v" id="sRentGap">$0</div></div>
        <div class="stat"><div class="k">Wealth share: top 20%</div><div class="v" id="sTopShare">0%</div></div>
      </div>

      <div class="mini" id="miniQ">
        <b>Quintiles</b>: different rent burden, saving, mortgage access, and sensitivity to downturns.
        <span class="tag">NEW: Govt+CRE+Cap</span>
      </div>

      <div class="footer">
        <b>Money creation channels:</b>
        (1) Bank lending → deposits created.
        (2) Govt deficit financed by bank bond purchases → deposits created.
        <br/>
        <b>Extraction channels:</b>
        Interest/fees → bank equity; rent → landlord equity; taxes → govt; CRE losses → bank equity hit → credit crunch.
      </div>
    </div>

    <!-- RIGHT -->
    <div class="rightcol">
      <div class="card">
        <h3>PIPELINES <span class="small">last-month flows</span></h3>
        <canvas id="flowCanvas" width="1200" height="560"></canvas>
        <div class="footer">
          <span style="color:var(--good)">Wages / Spending</span>,
          <span style="color:var(--accent2)">New Credit</span>,
          <span style="color:var(--bad)">Interest / Losses</span>,
          <span style="color:var(--ice)">Rent</span>,
          <span style="color:rgba(200,255,200,.85)">Taxes / Transfers</span>,
          <span style="color:rgba(255,220,170,.85)">Gov Spend (MTA+procurement)</span>.
        </div>
      </div>

      <div class="charts">
        <div class="card chartBox">
          <h3>MACRO <span class="small">deposits, loans, bank equity</span></h3>
          <canvas id="cMacro" class="chart"></canvas>
        </div>
        <div class="card chartBox">
          <h3>Rents + Housing + Cap <span class="small">asking/in-place, house, bank cap</span></h3>
          <canvas id="cRents" class="chart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const clamp = (x,a,b)=>Math.max(a, Math.min(b, x));
  const lerp = (a,b,t)=>a+(b-a)*t;

  function fmt(n){
    const sign = n < 0 ? "-" : "";
    n = Math.abs(n);
    if (n >= 1e12) return sign + "$" + (n/1e12).toFixed(2) + "T";
    if (n >= 1e9)  return sign + "$" + (n/1e9).toFixed(2) + "B";
    if (n >= 1e6)  return sign + "$" + (n/1e6).toFixed(2) + "M";
    if (n >= 1e3)  return sign + "$" + (n/1e3).toFixed(2) + "K";
    return sign + "$" + n.toFixed(0);
  }

  // ---------- State ----------
  const S = {
    t: 0,
    paused: true,
    speedMs: 60,

    // Calibration knobs
    simHH: 50000,
    realHH: 3380000,
    medianIncomeAnnual: 81228,
    mortgageAPR: 0.0611,
    housePrice: 777600,
    homeownershipRate: 0.328,

    askingRent: 3585,
    inPlaceRent: 1821,
    turnoverMonthly: 0.012, // 1.2% tenant turnover/month

    capTarget: 0.10,
    dtiBase: 0.35,
    creShare: 0.25,

    recessionSeverity: 0.25,
    govSize: 0.30,
    transferMult: 1.0,
    salesTax: 0.08875,

    cycleShock: 0,        // macro shock
    creVacShock: 0,       // CRE vacancy shock

    // Sectors (aggregate deposits)
    bank: { loans:0, equity: 4_000_000_000, rwa:0, spread: 0.020 },
    govt:{ deposits: 1_500_000_000, debt: 40_000_000_000 }, // stylized stock
    mta: { deposits: 300_000_000 },
    landlords: { deposits: 900_000_000, units: 0, equity: 6_000_000_000 },
    merchants: { deposits: 650_000_000 },
    developers: { deposits: 400_000_000, inventoryUnits: 12000 },
    corp: { deposits: 800_000_000, debt: 0, creValue: 0, vacancy: 0.18 }, // corporate/CRE sector

    Q: [],

    // last flows
    flows: {
      wages:0, spending:0,
      taxes:0, transfers:0,
      rent:0,
      newMortgages:0, newCRE:0,
      interestHH:0, interestCRE:0,
      principalHH:0, principalCRE:0,
      defaultsHH:0, defaultsCRE:0,
      govSpend:0, mtaSpend:0,
      bondIssue:0
    },

    hist: { labels:[], dep:[], loans:[], bankEq:[], bankCap:[], house:[], ask:[], inpl:[], topShare:[] }
  };

  function amortPayPerDollar(apr, years=30){
    const r = apr/12;
    const n = years*12;
    if (r === 0) return 1/n;
    return (r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
  }

  function rebuildQuintiles(){
    const med = S.medianIncomeAnnual;
    const incomes = [0.42*med, 0.70*med, 1.00*med, 1.55*med, 2.80*med];

    const q = [
      { name:"Q1 (bottom 20%)", share:0.20, income:incomes[0], rentersShare:0.93, save:0.02, spend:0.62, mortAccess:0.03, defSens:1.60 },
      { name:"Q2",             share:0.20, income:incomes[1], rentersShare:0.86, save:0.04, spend:0.56, mortAccess:0.06, defSens:1.25 },
      { name:"Q3 (median)",    share:0.20, income:incomes[2], rentersShare:0.74, save:0.07, spend:0.52, mortAccess:0.10, defSens:1.00 },
      { name:"Q4",             share:0.20, income:incomes[3], rentersShare:0.50, save:0.12, spend:0.46, mortAccess:0.16, defSens:0.75 },
      { name:"Q5 (top 20%)",   share:0.20, income:incomes[4], rentersShare:0.25, save:0.22, spend:0.38, mortAccess:0.22, defSens:0.55 }
    ];

    // Adjust rentersShare to hit overall homeownership target
    const impliedOwners = q.reduce((a,x)=>a + x.share*(1-x.rentersShare), 0);
    const delta = S.homeownershipRate - impliedOwners;
    const adj = (x, amt) => clamp(x - amt, 0.05, 0.98);
    q[4].rentersShare = adj(q[4].rentersShare, delta*0.9);
    q[3].rentersShare = adj(q[3].rentersShare, delta*0.6);
    q[2].rentersShare = adj(q[2].rentersShare, delta*0.3);

    const scale = S.realHH / S.simHH;
    S.Q = q.map((x, i) => {
      const hhCount = S.simHH * x.share;
      return {
        ...x,
        hh: hhCount,
        deposits: hhCount * 2800 * scale,
        mortgageDebt: hhCount * (i>=3 ? 45_000 : 15_000) * scale,
        ownedUnits: 0
      };
    });

    // Seed owner units distribution
    const totalOwnerUnits = S.realHH * S.homeownershipRate;
    const weights = [0.05,0.10,0.18,0.30,0.37];
    const wSum = weights.reduce((a,b)=>a+b,0);
    S.Q.forEach((g, idx) => {
      const owners = totalOwnerUnits*(weights[idx]/wSum);
      g.ownedUnits = owners / scale;
    });

    // rental stock held by landlords
    S.landlords.units = (S.realHH*(1 - S.homeownershipRate)) / scale;

    // corporate CRE: stylized value linked to house price scale (NYC CRE often larger, but keep stable)
    S.corp.creValue = S.housePrice * 6.5 * (S.realHH/3_380_000);
  }

  function totalDeposits(){
    const qDep = S.Q.reduce((a,g)=>a+g.deposits,0);
    return qDep + S.merchants.deposits + S.developers.deposits + S.landlords.deposits + S.govt.deposits + S.mta.deposits + S.corp.deposits;
  }

  function bankRWA(){
    // risk weights: HH mortgages ~50%, CRE loans ~100%, govt bonds ~0% (simplified)
    const creLoans = S.bank.loans * S.creShare;
    const hhLoans  = S.bank.loans * (1 - S.creShare);
    const rwa = 0.50*hhLoans + 1.00*creLoans;
    return Math.max(1, rwa);
  }

  function topWealthShare(){
    // Wealth proxy = deposits + housing equity - mortgage debt.
    const house = S.housePrice;
    const wealth = S.Q.map(g => g.deposits + g.ownedUnits*house - g.mortgageDebt);
    const total = wealth.reduce((a,b)=>a+b,0) || 1;
    return clamp(wealth[4]/total, 0, 1);
  }

  function creditTighteningMultiplier(){
    // If cap ratio < target, tighten credit & raise spreads.
    const cap = S.bank.equity / bankRWA();
    const shortfall = clamp((S.capTarget - cap) / S.capTarget, 0, 1);
    // 0 shortfall => 1.0 ; big shortfall => <1 lending
    return clamp(1 - 0.75*shortfall, 0.25, 1.05);
  }

  function effectiveIncomeTaxRate(annualIncome){
    // Stylized combined effective: Fed+State+City (progressive-ish, not exact).
    // Keep it realistic in shape:
    if (annualIncome < 30_000) return 0.06;
    if (annualIncome < 60_000) return 0.11;
    if (annualIncome < 120_000) return 0.17;
    if (annualIncome < 250_000) return 0.23;
    return 0.30;
  }

  function monthlyStep(){
    S.t++;
    for (const k of Object.keys(S.flows)) S.flows[k]=0;

    const scale = S.realHH / S.simHH;

    // Bank cap feedback
    S.bank.rwa = bankRWA();
    const capRatio = S.bank.equity / S.bank.rwa;
    const tightMul = creditTighteningMultiplier();

    // Macro shocks
    const shock = 1 + S.cycleShock;
    const wageDrop = 1 - S.recessionSeverity * clamp(-S.cycleShock, 0, 0.6);

    // -------------------------
    // 1) WAGES (private) — merchants + corp pay households
    // -------------------------
    let wageBill = 0;
    for (const g of S.Q){
      const incomeM = (g.income/12) * shock * wageDrop;
      const pay = g.hh * incomeM * scale;
      wageBill += pay;

      // Split wage payers: merchants 70%, corp 30%
      const mPay = pay*0.70, cPay = pay*0.30;

      if (S.merchants.deposits < mPay){
        const need = mPay - S.merchants.deposits;
        // working capital loan (bank creates deposits)
        S.bank.loans += need;
        S.merchants.deposits += need;
      }
      S.merchants.deposits -= mPay;

      if (S.corp.deposits < cPay){
        const need = cPay - S.corp.deposits;
        // corporate loan (also bank-created)
        S.bank.loans += need;
        S.corp.deposits += need;
        S.corp.debt += need;
      }
      S.corp.deposits -= cPay;

      g.deposits += pay;
    }
    S.flows.wages = wageBill;

    // -------------------------
    // 2) TAXES (income + payroll + sales + property)
    // -------------------------
    let taxes = 0;

    // Payroll taxes (employee side) stylized
    const payrollRate = 0.0765;

    for (const g of S.Q){
      const annual = g.income;
      const incTax = effectiveIncomeTaxRate(annual);
      const incomeTaxM = (annual*incTax)/12;
      const payrollM = (annual*payrollRate)/12;

      const due = (incomeTaxM + payrollM) * g.hh * scale;
      const paid = Math.min(due, g.deposits);

      g.deposits -= paid;
      S.govt.deposits += paid;
      taxes += paid;
    }

    // Sales tax on consumption (household spending later), computed after spending.
    // Property tax (owners & landlords) stylized: effective 0.85%/yr on house value equivalent
    const propEff = 0.0085/12;
    let propDue = 0;
    for (const g of S.Q){
      const ownerUnits = g.ownedUnits;
      propDue += ownerUnits * S.housePrice * propEff * scale;
    }
    propDue += S.landlords.units * S.housePrice * propEff * 0.92 * scale; // landlords often pay too

    // Pay property tax from deposits (owners/landlords)
    let propPaid = 0;
    for (const g of S.Q){
      const due = g.ownedUnits * S.housePrice * propEff * scale;
      const paid = Math.min(due, g.deposits);
      g.deposits -= paid;
      S.govt.deposits += paid;
      propPaid += paid;
    }
    const lDue = S.landlords.units * S.housePrice * propEff * 0.92 * scale;
    const lPaid = Math.min(lDue, S.landlords.deposits);
    S.landlords.deposits -= lPaid;
    S.govt.deposits += lPaid;
    propPaid += lPaid;

    taxes += propPaid;

    // -------------------------
    // 3) TRANSFERS (countercyclical; bottom-heavy)
    // -------------------------
    const recStress = clamp(-S.cycleShock, 0, 1) * S.recessionSeverity;
    const xferMult = S.transferMult;

    const baseXfer = 420 * scale; // per household per month baseline (stylized)
    const weights = [1.9, 1.35, 1.00, 0.60, 0.25];

    let transfers = 0;
    for (let i=0;i<5;i++){
      const g = S.Q[i];
      const perHH = baseXfer * weights[i] * xferMult * (1 + 1.3*recStress);
      const pay = perHH * g.hh;

      // If govt lacks deposits, issue bonds to bank (deficit financing creates deposits)
      if (S.govt.deposits < pay){
        const need = pay - S.govt.deposits;
        // Bank buys govt bonds: bank creates deposits to pay govt.
        S.bank.loans += need;      // treat as "bank asset expansion" for simplicity
        S.govt.debt += need;
        S.govt.deposits += need;
        S.flows.bondIssue += need;
      }

      S.govt.deposits -= pay;
      g.deposits += pay;
      transfers += pay;
    }
    S.flows.transfers = transfers;
    taxes += 0; // (sales tax later)
    S.flows.taxes = taxes;

    // -------------------------
    // 4) RENT (dual rent dynamics)
    //    in-place rent drifts toward asking via turnover
    // -------------------------
    // Asking rent moves with cycle; in-place sticky, gradually converges
    const askGrowth =
      0.0010
      + 0.0020*clamp(S.cycleShock,0,0.4)
      - 0.0030*clamp(-S.cycleShock,0,0.6)
      + 0.0012*clamp(S.askingRent / Math.max(1,S.inPlaceRent) - 1, 0, 2);

    S.askingRent *= clamp(1 + askGrowth, 0.985, 1.030);

    // In-place converges: inPlace += turnover*(asking - inPlace)*k
    const conv = clamp(S.turnoverMonthly * 0.55, 0.002, 0.03);
    S.inPlaceRent = S.inPlaceRent + conv*(S.askingRent - S.inPlaceRent);

    let rentFlow = 0;
    for (const g of S.Q){
      const renters = g.hh * g.rentersShare;

      // Lower quintiles closer to in-place; high-income closer to asking
      const mix = clamp((g.income / S.medianIncomeAnnual - 0.6)/2.0, 0, 1);
      const rent = lerp(S.inPlaceRent, S.askingRent, mix);

      const pay = renters * rent * scale;
      const paid = Math.min(pay, g.deposits);

      g.deposits -= paid;
      S.landlords.deposits += paid;
      rentFlow += paid;
    }
    S.flows.rent = rentFlow;

    // -------------------------
    // 5) HOUSEHOLD SPENDING (and sales tax)
    // -------------------------
    let spending = 0;
    for (const g of S.Q){
      const spendRate = clamp(g.spend - 0.10*clamp(-S.cycleShock,0,1), 0.18, 0.75);

      // buffer: 1.5 months of in-place rent
      const buffer = (g.hh * g.rentersShare) * (S.inPlaceRent) * scale * 1.5;
      const desired = g.deposits * spendRate;
      const maxSpend = Math.max(0, g.deposits - buffer);
      const pay = Math.min(desired, maxSpend);

      g.deposits -= pay;
      S.merchants.deposits += pay;
      spending += pay;
    }
    S.flows.spending = spending;

    // Sales tax
    const salesDue = spending * S.salesTax;
    const salesPaid = Math.min(salesDue, S.merchants.deposits);
    S.merchants.deposits -= salesPaid;
    S.govt.deposits += salesPaid;
    S.flows.taxes += salesPaid;

    // -------------------------
    // 6) GOV SPENDING: public payroll + procurement + MTA operations
    // -------------------------
    // Target gov spend ~ govSize% of private wages (stylized)
    const targetSpend = wageBill * S.govSize * (1 + 0.30*recStress);
    // Split: 45% public payroll (to households mid/top-heavy), 35% procurement (to merchants),
    // 20% MTA (to mta, then mta spends wages/procurement)
    const govPayroll = targetSpend * 0.45;
    const govProc = targetSpend * 0.35;
    const govMTA = targetSpend * 0.20;

    // finance spend (if insufficient deposits, issue bonds to bank)
    const needSpend = Math.max(0, targetSpend - S.govt.deposits);
    if (needSpend > 0){
      S.bank.loans += needSpend;
      S.govt.debt += needSpend;
      S.govt.deposits += needSpend;
      S.flows.bondIssue += needSpend;
    }

    // pay public payroll to Q3-Q5 more (NYC public sector has many mid incomes)
    const w = [0.10,0.18,0.26,0.26,0.20];
    for (let i=0;i<5;i++){
      const pay = govPayroll*w[i];
      S.govt.deposits -= pay;
      S.Q[i].deposits += pay;
    }

    // procurement to merchants
    const pPaid = Math.min(govProc, S.govt.deposits);
    S.govt.deposits -= pPaid;
    S.merchants.deposits += pPaid;

    // fund MTA
    const mtaPaid = Math.min(govMTA, S.govt.deposits);
    S.govt.deposits -= mtaPaid;
    S.mta.deposits += mtaPaid;

    // MTA spends: 65% wages (Q1-Q3 skew), 35% procurement
    const mtaW = mtaPaid*0.65;
    const mtaP = mtaPaid*0.35;
    const mw = [0.34,0.26,0.20,0.12,0.08];
    for (let i=0;i<5;i++){
      S.Q[i].deposits += mtaW*mw[i];
    }
    S.merchants.deposits += mtaP;
    S.mta.deposits -= (mtaW + mtaP);

    S.flows.govSpend = targetSpend;
    S.flows.mtaSpend = mtaPaid;

    // -------------------------
    // 7) CREDIT: mortgage origination (capital constrained + standards tighten)
    // -------------------------
    const payPerDollar = amortPayPerDollar(S.mortgageAPR + S.bank.spread, 30);
    // DTI tightens when cap shortfall or recession
    const cap = S.bank.equity / S.bank.rwa;
    const capShort = clamp((S.capTarget - cap)/S.capTarget, 0, 1);
    const dti = clamp(S.dtiBase * (1 - 0.25*capShort) * (1 - 0.15*recStress), 0.18, 0.55);

    // also mortgage access tightens when cap short
    const accessMul = clamp(tightMul * (1 - 0.35*recStress), 0.18, 1.05);

    let newMort = 0;
    const availableUnits = Math.floor(S.developers.inventoryUnits * 0.85);
    let unitsLeft = Math.max(0, availableUnits);

    for (const g of S.Q){
      if (unitsLeft <= 0) break;

      const desire = g.hh * g.mortAccess * accessMul * (0.92 + 0.25*clamp(S.cycleShock,0,0.5));
      let attempts = Math.floor(desire);

      const incomeM = (g.income/12) * shock;
      const maxPayment = incomeM * dti;
      const paymentForMedian = S.housePrice * payPerDollar;
      if (paymentForMedian > maxPayment){
        attempts = Math.floor(attempts * clamp(maxPayment / paymentForMedian, 0, 1));
      }

      const dpRate = 0.10 + 0.10*capShort + 0.06*recStress; // dp requirement rises in stress
      const dp = S.housePrice * dpRate;

      const avgDepositsPerHH = (g.deposits / Math.max(1, g.hh)) / scale;
      attempts = Math.floor(attempts * clamp(avgDepositsPerHH / dp, 0, 1));

      const purchases = Math.min(attempts, unitsLeft);
      if (purchases <= 0) continue;

      const principalPer = S.housePrice * (1 - dpRate);
      const principalTotal = purchases * principalPer * scale;
      const dpTotal = purchases * dp * scale;

      // Capital constraint: do not exceed max loans based on equity/target
      const maxLoans = (S.bank.equity / Math.max(1e-9, S.capTarget)) * 1.0; // rwa approx
      const headroom = Math.max(0, maxLoans - S.bank.loans);
      const lend = Math.min(principalTotal, headroom);
      const lendPurch = Math.floor(lend / (principalPer*scale));
      if (lendPurch <= 0) continue;

      const lendTotal = lendPurch * principalPer * scale;
      const dpNeed = lendPurch * dp * scale;

      // pay dp to developer
      const dpPaid = Math.min(dpNeed, g.deposits);
      g.deposits -= dpPaid;
      S.developers.deposits += dpPaid;

      // originate mortgage (creates deposits), then pay developer
      S.bank.loans += lendTotal;
      g.deposits += lendTotal;
      g.mortgageDebt += lendTotal;

      g.deposits -= lendTotal;
      S.developers.deposits += lendTotal;

      g.ownedUnits += lendPurch;
      unitsLeft -= lendPurch;

      newMort += lendTotal;
    }

    // update inventory
    S.developers.inventoryUnits = Math.max(0, S.developers.inventoryUnits - (availableUnits - unitsLeft));
    S.flows.newMortgages = newMort;

    // Developers build (simplified, slower in recession)
    const buildUnits = Math.floor(700 * clamp(1 - 0.75*recStress, 0.35, 1.0));
    if (buildUnits > 0){
      const costPerUnit = S.housePrice * 0.62;
      const cost = buildUnits * costPerUnit * scale;

      // dev loan (subject to cap headroom too)
      const maxLoans = (S.bank.equity / Math.max(1e-9, S.capTarget));
      const headroom = Math.max(0, maxLoans - S.bank.loans);
      const lend = Math.min(cost, headroom);

      if (lend > 0){
        S.bank.loans += lend;
        S.developers.deposits += lend;

        // pay labor/materials
        const labor = lend*0.46, materials = lend*0.44, fees = lend*0.10;
        const lw = [0.34,0.28,0.18,0.12,0.08];
        for (let i=0;i<5;i++) S.Q[i].deposits += labor*lw[i];
        S.merchants.deposits += materials;

        // bank fee becomes equity (financial rent)
        const bankFee = fees*0.55;
        S.bank.equity += bankFee;

        // inventory + build
        S.developers.inventoryUnits += buildUnits;
        S.developers.deposits -= (labor + materials + fees);
      }
    }

    // -------------------------
    // 8) CRE credit + vacancy shock
    // -------------------------
    // Vacancy rises in recession/CRE shock; lowers NOI; triggers defaults.
    S.corp.vacancy = clamp(S.corp.vacancy + 0.06*recStress + 0.10*clamp(S.creVacShock,0,1) - 0.02*clamp(S.cycleShock,0,1), 0.05, 0.45);

    // Corp borrows to roll CRE debt / invest in capex when easy
    const creDesire = S.corp.creValue * (0.0005 + 0.0012*clamp(S.cycleShock,0,0.5)) * accessMul;
    const creLoan = Math.max(0, creDesire);

    // Capital headroom
    const maxLoans = (S.bank.equity / Math.max(1e-9, S.capTarget));
    const headroom = Math.max(0, maxLoans - S.bank.loans);
    const lendCRE = Math.min(creLoan, headroom);

    if (lendCRE > 0){
      S.bank.loans += lendCRE;
      S.corp.deposits += lendCRE;
      S.corp.debt += lendCRE;
      S.flows.newCRE = lendCRE;

      // Corp spends capex with merchants (construction/services)
      const capex = lendCRE*0.78;
      const fees = lendCRE*0.04;
      const retained = lendCRE - capex - fees;

      S.merchants.deposits += capex;
      S.bank.equity += fees; // fees to bank
      S.corp.deposits -= (capex + fees);
      // retained stays in corp deposits
    }

    // -------------------------
    // 9) DEBT SERVICE: HH mortgages + CRE debt (interest extraction, principal destruction)
    // -------------------------
    let iHH=0,pHH=0, dHH=0;
    let iCRE=0,pCRE=0, dCRE=0;

    // HH servicing
    for (const g of S.Q){
      const debt = g.mortgageDebt;
      if (debt <= 0) continue;

      const rM = (S.mortgageAPR + S.bank.spread)/12;
      const payPer = amortPayPerDollar(S.mortgageAPR + S.bank.spread, 30);
      const interest = debt*rM;
      const payment = debt*payPer;
      const principal = Math.min(debt, Math.max(0, payment - interest));
      const due = interest + principal;

      const paid = Math.min(due, g.deposits);
      g.deposits -= paid;

      const iPaid = Math.min(interest, paid);
      const pPaid = Math.min(principal, Math.max(0, paid - iPaid));

      // interest -> bank equity
      S.bank.equity += iPaid;
      // principal reduces loans and debt
      S.bank.loans -= pPaid;
      g.mortgageDebt -= pPaid;

      iHH += iPaid; pHH += pPaid;

      // HH defaults: liquidity stress + recession
      const liquidity = (g.deposits / Math.max(1, (g.hh*(g.income/12)*scale)));
      const liqStress = clamp(1 - liquidity, 0, 1);
      const aff = S.housePrice / Math.max(1, S.medianIncomeAnnual);
      const affStress = clamp((aff - 8.0)/6.0, 0, 1);

      const base = 0.00055;
      const rate = base*(1 + 2.1*recStress + 1.6*liqStress + 1.6*affStress)*g.defSens;
      const dRate = clamp(rate, 0, 0.012);

      const loss = g.mortgageDebt * dRate;
      if (loss > 0){
        // collateral recovery reduces equity hit
        const equityHit = loss*(0.32 + 0.40*recStress);

        S.bank.loans -= loss;
        S.bank.equity -= equityHit;
        g.mortgageDebt -= loss;

        // foreclose units -> landlord stock
        const unitsLost = Math.min(g.ownedUnits, Math.floor((loss / S.housePrice)/scale));
        g.ownedUnits -= unitsLost;
        S.landlords.units += unitsLost;

        dHH += loss;
      }
    }

    // CRE servicing (interest-only-ish plus partial amort)
    if (S.corp.debt > 0){
      const creAPR = (S.mortgageAPR + S.bank.spread + 0.012); // risk premium
      const rM = creAPR/12;
      const interest = S.corp.debt*rM;
      const principal = S.corp.debt * 0.0025; // slow amort
      const due = interest + principal;

      const paid = Math.min(due, S.corp.deposits);
      S.corp.deposits -= paid;

      const iPaid = Math.min(interest, paid);
      const pPaid = Math.min(principal, Math.max(0, paid - iPaid));

      S.bank.equity += iPaid;
      S.bank.loans -= pPaid;
      S.corp.debt -= pPaid;

      iCRE += iPaid; pCRE += pPaid;

      // CRE defaults: vacancy shock + recession
      const noiStress = clamp((S.corp.vacancy - 0.18)/0.20, 0, 1);
      const base = 0.00075;
      const dRate = clamp(base*(1 + 2.8*noiStress + 1.7*recStress), 0, 0.02);
      const loss = S.corp.debt*dRate;
      if (loss > 0){
        const recoveryBad = 0.45 + 0.35*noiStress;
        const equityHit = loss*recoveryBad;

        S.bank.loans -= loss;
        S.bank.equity -= equityHit;
        S.corp.debt -= loss;

        dCRE += loss;
      }
    }

    S.flows.interestHH = iHH;
    S.flows.principalHH = pHH;
    S.flows.defaultsHH = dHH;

    S.flows.interestCRE = iCRE;
    S.flows.principalCRE = pCRE;
    S.flows.defaultsCRE = dCRE;

    // -------------------------
    // 10) Housing price dynamics: credit impulse + rent pressure + recession
    // -------------------------
    const creditImpulse = (S.flows.newMortgages) / Math.max(1, S.housePrice) / Math.max(1, S.realHH);
    const rentPressure = clamp(S.askingRent / Math.max(1,S.inPlaceRent) - 1, 0, 1.5);

    const priceGrowth =
      0.0010
      + 15.0*creditImpulse
      + 0.0014*rentPressure
      + 0.0008*clamp(S.cycleShock,0,0.4)
      - 0.0030*clamp(-S.cycleShock,0,0.8)
      - 0.0018*clamp((S.capTarget - capRatio)/S.capTarget, 0, 1);

    S.housePrice *= clamp(1 + priceGrowth, 0.975, 1.030);

    // landlord equity proxy
    S.landlords.equity = S.landlords.units*S.housePrice + S.landlords.deposits;

    // Bank spread reacts (tightening after losses)
    const lossStress = clamp((dHH + dCRE)/Math.max(1, S.bank.loans), 0, 0.03);
    S.bank.spread = clamp(0.018 + 0.10*capShort + 0.30*lossStress, 0.012, 0.080);

    // decay shocks
    S.cycleShock *= 0.92;
    S.creVacShock *= 0.90;

    // -------------------------
    // 11) Record history
    // -------------------------
    const dep = totalDeposits();
    const topShare = topWealthShare()*100;

    S.hist.labels.push(`${Math.floor(S.t/12)}y ${S.t%12}m`);
    S.hist.dep.push(dep);
    S.hist.loans.push(S.bank.loans);
    S.hist.bankEq.push(S.bank.equity);
    S.hist.bankCap.push((S.bank.equity / bankRWA())*100);
    S.hist.house.push(S.housePrice);
    S.hist.ask.push(S.askingRent);
    S.hist.inpl.push(S.inPlaceRent);
    S.hist.topShare.push(topShare);

    const maxN = 520;
    if (S.hist.labels.length > maxN){
      for (const k of Object.keys(S.hist)) S.hist[k].shift();
    }
  }

  // ---------- UI ----------
  function syncUI(){
    S.simHH = +$("simHH").value;
    S.realHH = +$("realHH").value;
    S.medianIncomeAnnual = +$("medInc").value;
    S.mortgageAPR = +$("rate").value/10000;
    S.housePrice = +$("home").value;
    S.homeownershipRate = +$("own").value/100;

    S.askingRent = +$("askRent").value;
    S.inPlaceRent = +$("inPlace").value;
    S.turnoverMonthly = +$("turn").value/10000;

    S.capTarget = +$("cap").value/100;
    S.dtiBase = +$("dti").value/100;
    S.creShare = +$("creShare").value/100;

    S.recessionSeverity = +$("recession").value/100;
    S.govSize = +$("govSize").value/100;
    S.transferMult = +$("xfer").value/100;
    S.salesTax = +$("sales").value/10000;

    $("vSimHH").textContent = S.simHH.toLocaleString();
    $("vRealHH").textContent = S.realHH.toLocaleString();
    $("vMedInc").textContent = fmt(S.medianIncomeAnnual);
    $("vRate").textContent = (S.mortgageAPR*100).toFixed(2) + "%";
    $("vHome").textContent = fmt(S.housePrice);
    $("vOwn").textContent = (S.homeownershipRate*100).toFixed(1) + "%";

    $("vAskRent").textContent = fmt(S.askingRent);
    $("vInPlace").textContent = fmt(S.inPlaceRent);
    $("vTurn").textContent = (S.turnoverMonthly*100).toFixed(2) + "%";

    $("vCap").textContent = (S.capTarget*100).toFixed(1) + "%";
    $("vDTI").textContent = S.dtiBase.toFixed(2);
    $("vCRE").textContent = Math.round(S.creShare*100) + "%";

    $("vRec").textContent = S.recessionSeverity.toFixed(2);
    $("vGovSize").textContent = Math.round(S.govSize*100) + "%";
    $("vXfer").textContent = S.transferMult.toFixed(2) + "×";
    $("vSales").textContent = (S.salesTax*100).toFixed(3) + "%";

    rebuildQuintiles();
    renderMiniQuintiles();
    renderStats();
    refreshCharts();
  }

  for (const id of ["simHH","realHH","medInc","rate","home","own","askRent","inPlace","turn","cap","dti","creShare","recession","govSize","xfer","sales"]){
    $(id).addEventListener("input", syncUI);
  }

  $("btnShock").addEventListener("click", ()=>{
    S.cycleShock -= 0.25;
    S.creVacShock += 0.35;
    renderStats();
  });
  $("btnBoom").addEventListener("click", ()=>{
    S.cycleShock += 0.16;
    renderStats();
  });

  function renderMiniQuintiles(){
    const scale = S.realHH / S.simHH;
    const lines = S.Q.map(g=>{
      const ownersPct = (1 - g.rentersShare)*100;
      const depPer = (g.deposits/Math.max(1,g.hh))/scale;
      return `${g.name}: income≈${fmt(g.income)}/yr • renters≈${(g.rentersShare*100).toFixed(0)}% • owners≈${ownersPct.toFixed(0)}% • mortAccess=${(g.mortAccess*100).toFixed(0)}% • deposits≈${fmt(depPer)} per hh`;
    });
    $("miniQ").innerHTML = `<b>Quintiles</b> (bottom→top):<br>` + lines.join("<br>");
  }

  function renderStats(){
    const dep = totalDeposits();
    const cap = (S.bank.equity / bankRWA())*100;
    const topShare = topWealthShare()*100;
    const gap = S.askingRent - S.inPlaceRent;

    $("sDep").textContent = fmt(dep);
    $("sLoans").textContent = fmt(S.bank.loans);
    $("sEq").textContent = fmt(S.bank.equity);
    $("sCap").textContent = cap.toFixed(2) + "%";
    $("sGovDebt").textContent = fmt(S.govt.debt);
    $("sDef").textContent = fmt(S.flows.bondIssue - Math.max(0,S.flows.taxes - S.flows.transfers)); // rough signal
    $("sRentGap").textContent = `${fmt(S.askingRent)} / ${fmt(S.inPlaceRent)} (Δ ${fmt(gap)})`;
    $("sTopShare").textContent = topShare.toFixed(1) + "%";

    $("statusPill").textContent =
      `t=${S.t} months • ${S.paused ? "paused" : "running"} • house=${fmt(S.housePrice)} • askRent=${fmt(S.askingRent)} • cap=${cap.toFixed(2)}% • spread=${(S.bank.spread*100).toFixed(2)}% • vacancy=${(S.corp.vacancy*100).toFixed(1)}%`;
  }

  // ---------- Charts ----------
  const macroChart = new Chart($("cMacro"), {
    type:"line",
    data:{ labels:[], datasets:[
      { label:"Total Deposits", data:[], borderWidth:2, tension:0.25 },
      { label:"Bank Loans", data:[], borderWidth:2, tension:0.25 },
      { label:"Bank Equity", data:[], borderWidth:2, tension:0.25 }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:"#E6F1F3" } },
        tooltip:{ callbacks:{ label:(c)=>`${c.dataset.label}: ${fmt(c.parsed.y)}` } } },
      scales:{
        x:{ ticks:{ color:"#9FB7BF", maxTicksLimit:6 }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"#9FB7BF", callback:(v)=>fmt(v) }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });

  const rentsChart = new Chart($("cRents"), {
    type:"line",
    data:{ labels:[], datasets:[
      { label:"Asking Rent (monthly)", data:[], borderWidth:2, tension:0.25 },
      { label:"In-Place Rent (monthly)", data:[], borderWidth:2, tension:0.25 },
      { label:"House Price", data:[], borderWidth:2, tension:0.25 },
      { label:"Bank Cap Ratio (%)", data:[], borderWidth:2, tension:0.25 }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{ labels:{ color:"#E6F1F3" } },
        tooltip:{ callbacks:{ label:(c)=>{
          if (c.dataset.label.includes("Cap")) return `${c.dataset.label}: ${c.parsed.y.toFixed(2)}%`;
          return `${c.dataset.label}: ${fmt(c.parsed.y)}`;
        } } } },
      scales:{
        x:{ ticks:{ color:"#9FB7BF", maxTicksLimit:6 }, grid:{ color:"rgba(255,255,255,.06)" } },
        y:{ ticks:{ color:"#9FB7BF" }, grid:{ color:"rgba(255,255,255,.06)" } }
      }
    }
  });

  function refreshCharts(){
    macroChart.data.labels = S.hist.labels;
    macroChart.data.datasets[0].data = S.hist.dep;
    macroChart.data.datasets[1].data = S.hist.loans;
    macroChart.data.datasets[2].data = S.hist.bankEq;
    macroChart.update("none");

    rentsChart.data.labels = S.hist.labels;
    rentsChart.data.datasets[0].data = S.hist.ask;
    rentsChart.data.datasets[1].data = S.hist.inpl;
    rentsChart.data.datasets[2].data = S.hist.house;
    rentsChart.data.datasets[3].data = S.hist.bankCap;
    rentsChart.update("none");
  }

  // ---------- Pipeline viz ----------
  const canvas = $("flowCanvas");
  const ctx = canvas.getContext("2d");
  const DPR = Math.max(1, Math.floor(window.devicePixelRatio || 1));

  function resizeCanvas(){
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    canvas.width = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  const nodes = {
    bank:   { x: 0.10, y: 0.45, r: 34, label: "BANK" },
    hh:     { x: 0.48, y: 0.16, r: 34, label: "HOUSEHOLDS" },
    merch:  { x: 0.88, y: 0.38, r: 34, label: "MERCHANTS" },
    land:   { x: 0.50, y: 0.83, r: 34, label: "LANDLORDS" },
    govt:   { x: 0.20, y: 0.18, r: 30, label: "GOVT" },
    corp:   { x: 0.86, y: 0.78, r: 30, label: "CORP/CRE" },
    dev:    { x: 0.22, y: 0.82, r: 28, label: "DEVS" }
  };

  const edges = [
    // real economy
    { id:"wages",        from:"merch", to:"hh",   color:"rgba(57,217,138,.95)" },
    { id:"spending",     from:"hh",    to:"merch",color:"rgba(57,217,138,.62)" },
    // rent pipe
    { id:"rent",         from:"hh",    to:"land", color:"rgba(180,220,255,.92)" },
    // taxes + transfers
    { id:"taxes",        from:"hh",    to:"govt", color:"rgba(200,255,200,.70)" },
    { id:"transfers",    from:"govt",  to:"hh",   color:"rgba(200,255,200,.92)" },
    // govt spend
    { id:"govSpend",     from:"govt",  to:"merch",color:"rgba(255,220,170,.80)" },
    // credit creation
    { id:"newMortgages", from:"bank",  to:"hh",   color:"rgba(255,183,3,.95)" },
    { id:"newCRE",       from:"bank",  to:"corp", color:"rgba(255,183,3,.70)" },
    // interest extraction
    { id:"interestHH",   from:"hh",    to:"bank", color:"rgba(255,107,107,.92)" },
    { id:"interestCRE",  from:"corp",  to:"bank", color:"rgba(255,107,107,.70)" }
  ];

  const particles = [];
  function spawnParticles(){
    const f = S.flows;
    const scale = 1 / 180_000_000; // tune for NYC-sized flows
    for (const e of edges){
      const m = Math.max(0, f[e.id] || 0);
      const count = clamp(Math.floor(m * scale), 0, 20);
      for (let i=0;i<count;i++){
        particles.push({ edgeId:e.id, t:Math.random(), v:0.010+Math.random()*0.014 });
      }
    }
    while (particles.length > 260) particles.shift();
  }

  function nodePos(key){
    const n = nodes[key];
    return { x:n.x*canvas.width, y:n.y*canvas.height, r:n.r*DPR };
  }

  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // subtle grid
    ctx.save();
    ctx.globalAlpha = 0.16;
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.lineWidth = 1*DPR;
    const step = 52*DPR;
    for (let x=0;x<canvas.width;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
    for (let y=0;y<canvas.height;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }
    ctx.restore();

    // edges
    for (const e of edges){
      const a = nodePos(e.from), b = nodePos(e.to);
      const mag = Math.max(0, S.flows[e.id] || 0);

      const w = (1.2 + Math.sqrt(mag)/90000) * DPR;
      const alpha = clamp(0.18 + Math.sqrt(mag)/1_000_000, 0.18, 0.92);

      const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
      const dx=b.x-a.x, dy=b.y-a.y;
      const bend=0.16;
      const cx=mx - dy*bend, cy=my + dx*bend;

      ctx.save();
      ctx.strokeStyle = e.color;
      ctx.globalAlpha = alpha;
      ctx.lineWidth = w;
      ctx.lineCap = "round";
      ctx.beginPath();
      ctx.moveTo(a.x,a.y);
      ctx.quadraticCurveTo(cx,cy,b.x,b.y);
      ctx.stroke();
      ctx.restore();
    }

    // particles
    for (const p of particles){
      const e = edges.find(x=>x.id===p.edgeId);
      if (!e) continue;
      p.t += p.v;
      if (p.t>1) p.t-=1;

      const a=nodePos(e.from), b=nodePos(e.to);
      const mx=(a.x+b.x)/2, my=(a.y+b.y)/2;
      const dx=b.x-a.x, dy=b.y-a.y;
      const bend=0.16;
      const cx=mx - dy*bend, cy=my + dx*bend;

      const t=p.t;
      const x=(1-t)*(1-t)*a.x + 2*(1-t)*t*cx + t*t*b.x;
      const y=(1-t)*(1-t)*a.y + 2*(1-t)*t*cy + t*t*b.y;

      ctx.save();
      ctx.globalAlpha = 0.86;
      ctx.fillStyle = e.color;
      ctx.beginPath();
      ctx.arc(x,y,3.2*DPR,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // nodes
    for (const k of Object.keys(nodes)){
      const n=nodePos(k);
      ctx.save();
      ctx.shadowColor="rgba(242,166,90,.22)";
      ctx.shadowBlur=18*DPR;
      ctx.fillStyle="rgba(0,0,0,.26)";
      ctx.beginPath(); ctx.arc(n.x,n.y,n.r+10*DPR,0,Math.PI*2); ctx.fill();
      ctx.restore();

      ctx.save();
      ctx.fillStyle="rgba(18,63,79,.92)";
      ctx.strokeStyle="rgba(255,255,255,.18)";
      ctx.lineWidth=2*DPR;
      ctx.beginPath(); ctx.arc(n.x,n.y,n.r,0,Math.PI*2); ctx.fill(); ctx.stroke();
      ctx.restore();

      ctx.save();
      ctx.fillStyle="rgba(230,241,243,.92)";
      ctx.font = `${12*DPR}px ${getComputedStyle(document.documentElement).getPropertyValue('--mono')}`;
      ctx.textAlign="center";
      ctx.fillText(nodes[k].label, n.x, n.y+4*DPR);
      ctx.restore();
    }

    requestAnimationFrame(draw);
  }

  // ---------- Loop ----------
  let timer=null;
  function tick(){
    monthlyStep();
    spawnParticles();
    renderStats();
    refreshCharts();
  }
  function play(){
    if (!S.paused) return;
    S.paused=false; $("btnPlay").textContent="⏸ PAUSE";
    timer=setInterval(tick, S.speedMs);
    renderStats();
  }
  function pause(){
    S.paused=true; $("btnPlay").textContent="▶ RUN";
    if (timer){ clearInterval(timer); timer=null; }
    renderStats();
  }
  $("btnPlay").addEventListener("click", ()=> S.paused ? play() : pause());
  $("btnStep").addEventListener("click", ()=> { if (!S.paused) return; tick(); });

  function resetAll(){
    pause();
    S.t=0; S.cycleShock=0; S.creVacShock=0;

    S.bank = { loans:0, equity: 4_000_000_000, rwa:0, spread: 0.020 };
    S.govt = { deposits: 1_500_000_000, debt: 40_000_000_000 };
    S.mta  = { deposits: 300_000_000 };
    S.landlords = { deposits: 900_000_000, units: 0, equity: 6_000_000_000 };
    S.merchants = { deposits: 650_000_000 };
    S.developers= { deposits: 400_000_000, inventoryUnits: 12000 };
    S.corp = { deposits: 800_000_000, debt: 0, creValue: S.housePrice*6.5, vacancy: 0.18 };

    for (const k of Object.keys(S.flows)) S.flows[k]=0;
    S.hist = { labels:[], dep:[], loans:[], bankEq:[], bankCap:[], house:[], ask:[], inpl:[], topShare:[] };

    rebuildQuintiles();
    renderMiniQuintiles();
    renderStats();
    refreshCharts();
  }
  $("btnReset").addEventListener("click", resetAll);

  // init
  rebuildQuintiles();
  renderMiniQuintiles();
  for (let i=0;i<6;i++) monthlyStep();
  pause();
  refreshCharts();
  renderStats();
  draw();

  // initial labels
  function setUI(){
    $("vSimHH").textContent = S.simHH.toLocaleString();
    $("vRealHH").textContent = S.realHH.toLocaleString();
    $("vMedInc").textContent = fmt(S.medianIncomeAnnual);
    $("vRate").textContent = (S.mortgageAPR*100).toFixed(2) + "%";
    $("vHome").textContent = fmt(S.housePrice);
    $("vOwn").textContent = (S.homeownershipRate*100).toFixed(1) + "%";
    $("vAskRent").textContent = fmt(S.askingRent);
    $("vInPlace").textContent = fmt(S.inPlaceRent);
    $("vTurn").textContent = (S.turnoverMonthly*100).toFixed(2) + "%";
    $("vCap").textContent = (S.capTarget*100).toFixed(1) + "%";
    $("vDTI").textContent = S.dtiBase.toFixed(2);
    $("vCRE").textContent = Math.round(S.creShare*100) + "%";
    $("vRec").textContent = S.recessionSeverity.toFixed(2);
    $("vGovSize").textContent = Math.round(S.govSize*100) + "%";
    $("vXfer").textContent = S.transferMult.toFixed(2) + "×";
    $("vSales").textContent = (S.salesTax*100).toFixed(3) + "%";
  }
  setUI();
})();
</script>
</body>
</html>
